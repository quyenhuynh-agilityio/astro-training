---
import BaseLayout from '@layouts/BaseLayout/index.astro';
import PropertyHeroSection from '@sections/PropertyHeroSection/index.astro';
import PropertyDetail from '@sections/PropertyDetailSection/index.astro';
import Footer from '@layouts/Footer/index.astro';
import { loadQuery } from '../../../studio/lib/load-query';

import { detailPageQuery, propertyQuery } from '@queries/index';
import type { HomePageType } from '@types-local/home';
import type { Property } from '@types-local/property';

// Get static paths for all properties
export async function getStaticPaths() {
  const { data: properties } = await loadQuery<{ slug: { current: string } }[]>(
    {
      query: `*[_type == "homePage" && defined(slug.current)] { slug }`,
    }
  );

  return properties.map((property) => ({
    params: { slug: property.slug.current },
  }));
}

const { slug } = Astro.params;

const fullSlug = `property/${slug}`;

const { data: property } = await loadQuery<Property>({
  query: propertyQuery,
  params: { slug: fullSlug },
});

const { data: detailPage } = await loadQuery<HomePageType>({
  query: detailPageQuery,
});
const { header, footer } = detailPage;

// Handle case where property is not found
if (!property) {
  return Astro.redirect('/404'); // Redirect to 404 page
}

console.log('property', property);
---

<BaseLayout title="Detail Page">
  <PropertyHeroSection
    title={property?.title}
    address={property?.address}
    price={property?.price}
    pricePerSqft={property?.pricePerSqft}
    logo={header.logo}
    navItems={header.navItems}
    ctaText={header.ctaText}
  />

  <PropertyDetail {property} />
  <Footer
    logo={footer.logo}
    socialLinks={footer.socialLinks}
    ctaText={footer.ctaText}
    columns={footer.links}
  />
</BaseLayout>
